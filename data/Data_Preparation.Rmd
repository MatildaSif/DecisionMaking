---
title: "Data_Preparation"
output: html_document
---

GOAL:
Load all three datasets (controls, heroin, ampamphetamine)
Ensure identical formatting across groups
Check for missing data, outliers, or unusual patterns
Verify participants completed sufficient trials (ideally 95-100 trials)

```{r}
# Load necessary libraries
library(dplyr)
library(ggplot2)
library(tidyverse)
```

''' LOADING DATA '''
```{r}
# set working directory for whole notebook
getwd()

# Load datasets txt file
controls <- read.table("../data/IGTdata_healthy_control.txt")
heroin <- read.csv("../data/IGTdata_heroin.txt") # needs to be read.csv for the file format
amp <- read.csv("../data/IGTdata_amphetamine.txt") # needs to be read.csv for the file format

# convert table to csv
write.csv(controls, "../data/IGTdata_healthy_control.csv", row.names = FALSE)
write.csv(heroin, "../data/IGTdata_heroin.csv", row.names = FALSE)
write.csv(amp, "../data/IGTdata_amphetamine.csv", row.names = FALSE)

# Load csvs
controls <-read.csv("../data/IGTdata_healthy_control.csv")
heroin <- read.csv("../data/IGTdata_heroin.csv")
amp <- read.csv("../data/IGTdata_amphetamine.csv")

# set row 1 in each df as the column names and delete row 1
colnames(controls) <- as.character(unlist(controls[1, ])) 
colnames(heroin) <- as.character(unlist(heroin[1, ]))
colnames(amp) <- as.character(unlist(amp[1, ]))

# delete row 1 with old column names
controls <- controls[-1, ]
heroin <- heroin[-1, ]
amp <- amp[-1, ]

# set trials to be numeric column for all dfs
controls$trial <- as.numeric(controls$trial)
heroin$trial <- as.numeric(heroin$trial)
amp$trial <- as.numeric(amp$trial)

```

''' MERGE DATA* '''
```{r}
# merge data frames into one for easier processing
controls$group <- 'control'
heroin$group <- 'heroin'
amp$group <- 'amphetamine'

# merge all data into one data frame for easier processing
all_data <- bind_rows(controls, heroin, amp)
all_data$trial <- as.numeric(all_data$trial)

# collect data for easy plotting
all_data <- all_data %>%
  mutate(gain = as.numeric(gain),
         loss = as.numeric(loss),
         payoff = gain + loss) %>%
  group_by(subjID, group) %>%
  arrange(trial) %>%
  mutate(cumulative_payoff = cumsum(payoff))

```

''' PARTICIPANT AND TRIAL COUNT '''
```{r}
# Table counting no. of completed trials per participant in each group
all_data %>%
  group_by(subjID, group) %>%
  summarise(max_trials = max(trial)) %>%
  group_by(max_trials, group) %>%
  summarise(count = n()) %>%
  arrange(group, desc(max_trials))

# check how many participants have different number of max trials per group
controls %>% 
  group_by(subjID) %>%
  summarise(max_trials = max(trial)) %>%
  group_by(max_trials) %>%
  summarise(count = n()) %>%
  arrange(desc(max_trials))


heroin %>%
  group_by(subjID) %>%
  summarise(max_trials = max(trial)) %>%
  group_by(max_trials) %>%
  summarise(count = n()) %>%
  arrange(desc(max_trials))

amp %>%
  group_by(subjID) %>%
  summarise(max_trials = max(trial)) %>%
  group_by(max_trials) %>%
  summarise(count = n()) %>%
  arrange(desc(max_trials))

```


```{r}
# Count no. participants in each dataset
all_data %>%
  group_by(group) %>%
  summarise(count = n_distinct(subjID))
```

```{r}
# Check for missing data
sum(is.na(all_data))
```

 ''' ADV / DISADV DECKS PLOTTING AND DEFINING '''
```{r}
# split decks into adv and disadv decks
#two of the decks (decks C and D) are advantageous (“good”) and two (decks A and B) are disadvantageous (“bad”) in terms of their long-term payoffs.
all_data <- all_data %>%
  mutate(deck_type = case_when(
    deck %in% c("1", "2") ~ "disadvantageous",
    deck %in% c("3", "4") ~ "advantageous",
    TRUE ~ NA_character_
  ))

# split the 100 trials were divided into five blocks of 20 trials
all_data <- all_data %>%  
  mutate(trial = as.numeric(trial)) %>%
  mutate(block = case_when(
    trial >= 1  & trial <= 19 ~ 1,
    trial >= 20 & trial <= 39 ~ 2,
    trial >= 40 & trial <= 59 ~ 3,
    trial >= 60 & trial <= 79 ~ 4,
    trial >= 80 & trial <= 100 ~ 5
  ))

# ADD BASELINE: Trial 0 with cumulative_payoff = 0 for each subject
# This ensures cumulative payoff plots start at 0
baseline <- all_data %>%
  distinct(subjID, group) %>%
  mutate(trial = 0, 
         cumulative_payoff = 0,
         deck = NA_character_,
         gain = 0,
         loss = 0,
         payoff = 0,
         deck_type = NA_character_,
         block = 0)

# After adding baseline and arranging
all_data <- bind_rows(baseline, all_data) %>%
  arrange(subjID, trial) %>%
  group_by(subjID) %>%
  mutate(cumulative_payoff = cumsum(payoff)) %>%  # Recalculate!
  ungroup()

sum(is.na(all_data)) # there is are two NAs for each trial "0" baseline added (one for deck and one for dec_type)
```

''' PLOT PAYOFF'''
```{r}
# Plot payoff per group as a distribution. Payoff is the total sum of gains and losses per participant
all_data %>%
  filter(trial > 0) %>%  # Exclude baseline for summary statistics
  group_by(subjID, group) %>%
  summarise(payoff = sum(as.numeric(gain)) + sum(as.numeric(loss))) %>%
  ggplot(aes(x = payoff, fill = group)) +
  geom_histogram(position = "dodge", bins = 30, alpha = 0.7) +
  labs(title = "Distribution of Payoff by Group",
       x = "Payoff (Total Gains + Losses)",
       y = "Count of Participants") +
  theme_minimal()


# plot again as a line with density plotting total accumulative payoff over trials
all_data %>%
  ggplot(aes(x = trial, y = cumulative_payoff, group = subjID, color = group)) +
  stat_summary(aes(group = group, color = group), fun = mean, geom = "line", size = 1.5) +
  labs(title = "Cumulative Payoff Over Trials by Group",
       x = "Trial",
       y = "Cumulative Payoff") +
  theme_minimal()

# smoothed lines
all_data %>%
  ggplot(aes(x = trial, y = cumulative_payoff, color = group)) +
  geom_smooth(aes(group = group), ampod = "loess", se = TRUE, size = 1.5) +
  labs(title = "Cumulative Payoff Over Trials by Group (with SE)",
       x = "Trial",
       y = "Cumulative Payoff") +
  theme_minimal()

```

```{r}
# plot payoff per deck by group
all_data %>%
  filter(trial > 0) %>%  # Exclude baseline
  group_by(subjID, group, deck) %>%
  summarise(cumulative_payoff = sum(as.numeric(gain)) + sum(as.numeric(loss))) %>%
  ggplot(aes(x = deck, y = cumulative_payoff, fill = group)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7) +
  labs(title = "Total Payoff by Deck and Group",
       x = "Deck",
       y = "Total Payoff (Gains + Losses)") +
  theme_minimal()
```

```{r}
# plot payoff per deck overall
all_data %>%
  filter(trial > 0) %>%  # Exclude baseline
  group_by(deck) %>%
  summarise(cumulative_payoff = sum(as.numeric(gain)) + sum(as.numeric(loss))) %>%
  ggplot(aes(x = deck, y = cumulative_payoff, fill = deck)) +
  geom_bar(stat = "identity", alpha = 0.7) +
  labs(title = "Total Payoff by Deck",
       x = "Deck",
       y = "Total Payoff (Gains + Losses)") +
    scale_y_continuous(labels = scales::comma) +
  theme_minimal()
```

```{r}
# Total payoff mean across participants
# plot average payoff per deck across participants
all_data %>%
  filter(trial > 0) %>%  # Exclude baseline
  group_by(subjID, deck) %>%
  summarise(total_payoff = sum(as.numeric(gain)) + sum(as.numeric(loss)), .groups = "drop") %>%
  group_by(deck) %>%
  summarise(mean_payoff = mean(total_payoff)) %>%
  ggplot(aes(x = deck, y = mean_payoff, fill = deck)) +
  geom_bar(stat = "identity", alpha = 0.7) +
  labs(title = "Average Payoff by Deck Across Participants",
       x = "Deck",
       y = "Average Payoff (Gains + Losses)") +
  scale_y_continuous(labels = scales::comma, breaks = seq(-2000, 1000, by = 500)) +  # More breaks
  theme_minimal()
```


```{r}
# Check which rows have NA or non-numeric values in the plotting variable - ALL GOOD now
summary(all_data$block)
unique(all_data$trial[is.na(all_data$block)])
```

```{r}
# Line Plot net score of “advantageous”—“disadvantageous” choices
all_data %>%
  group_by(subjID, group, deck_type) %>%
  summarise(total_choices = n()) %>%
  pivot_wider(names_from = deck_type, values_from = total_choices, values_fill = 0) %>%
  mutate(net_score = advantageous - disadvantageous) %>%
  ggplot(aes(x = group, y = net_score, fill = group)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Net Score of Advantageous vs Disadvantageous Choices by Group",
       x = "Group",
       y = "Net Score (Advantageous - Disadvantageous)") +
  theme_minimal()

# now with geom_line showing over blocks where 100 trials are split into 5 blocks
all_data %>%
  group_by(subjID, group, block, deck_type) %>%
  summarise(total_choices = n(), .groups = "drop") %>%
  pivot_wider(names_from = deck_type, values_from = total_choices, values_fill = 0) %>%
  mutate(net_score = advantageous - disadvantageous) %>%
  ggplot(aes(x = block, y = net_score, color = group)) +
  stat_summary(aes(group = group, color = group), fun = mean, geom = "line", size = 1.5) +
  labs(title = "Net Score of Advantageous vs Disadvantageous Choices Over Blocks by Group",
       x = "Block (20 Trials Each)",
       y = "Net Score (Advantageous - Disadvantageous)") +
  theme_minimal()

```

```{r}
# Check average payoff per deck
all_data %>%
  filter(trial > 0) %>%
  group_by(deck) %>%
  summarise(
    mean_gain = mean(as.numeric(gain)),
    mean_loss = mean(as.numeric(loss)),
    mean_payoff = mean(as.numeric(gain) + as.numeric(loss)),
    total_payoff = sum(as.numeric(gain) + as.numeric(loss))
  ) %>%
  arrange(desc(mean_payoff))
```


GOALS:
Calculate basic performance metrics for each group:
% choices from "good" decks (C, D) vs. "bad" decks (A, B)
Learning curves across trial blocks
Total money won/lost

```{r}
# Calculate % choices from "good" decks (C, D) vs. "bad" decks (A, B) - computes the mean across subjects in each group
all_data %>%
  filter(trial > 0) %>%
  group_by(subjID, group, deck_type) %>%
  summarise(total_choices = n()) %>%
  pivot_wider(names_from = deck_type, values_from = total_choices, values_fill = 0) %>%
  mutate(total = advantageous + disadvantageous,
         percent_advantageous = (advantageous / total) * 100,
         percent_disadvantageous = (disadvantageous / total) * 100) %>%
  group_by(group) %>%
  summarise(mean_percent_advantageous = mean(percent_advantageous),
            mean_percent_disadvantageous = mean(percent_disadvantageous))
```

```{r}
# percentage of choices per deck by group - BEST AS IT IS RELATIVE TO NO. TRIALS
deck_counts <- all_data %>%
  filter(trial > 0) %>% # remove baseline
  group_by(group, deck) %>%
  summarise(n_choices = n(), .groups = "drop") %>%
  group_by(group) %>%
  mutate(percent = n_choices / sum(n_choices) * 100)

ggplot(deck_counts, aes(x = deck, y = percent, fill = group)) +
  geom_col(position = "dodge") +
  labs(
    title = "Percent of Choices per Deck by Group",
    x = "Deck",
    y = "Percent of Choices"
  ) +
  theme_minimal() +
  scale_fill_brewer(palette = "Set1")
```


```{r}
# Plot how advantageous and disadvantageous decks are chosen per group
adv_disadv_counts <- all_data %>%
  filter(trial > 0) %>% # remove baseline
  group_by(group, deck_type) %>%
  summarise(n_choices = n(), .groups = "drop") %>% 
  group_by(group) %>%
  mutate(percent = n_choices / sum(n_choices) * 100)

ggplot(adv_disadv_counts, aes(x = deck_type, y = percent, fill = group))+
  geom_col(position = "dodge") +
  labs(
    title = "Number of Choices per Type of Deck by Group",
    x = "Deck Type",
    y = "Number of Choices"
  ) +
  theme_minimal() +
  scale_fill_brewer(palette = "Set1"

```

