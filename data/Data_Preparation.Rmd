---
title: "Data_Preparation"
output: html_document
---

GOAL:
Load all three datasets (controls, heroin, methamphetamine)
Ensure identical formatting across groups
Check for missing data, outliers, or unusual patterns
Verify participants completed sufficient trials (ideally 95-100 trials)

```{r}
# Load necessary libraries
library(dplyr)
library(ggplot2)
library(tidyverse)
```


```{r}
# set working directory for whole notebook
getwd()

# Load datasets txt file
controls <- read.table("../data/IGTdata_healthy_control.txt")
heroin <- read.csv("../data/IGTdata_heroin.txt") # needs to be read.csv for the file format
meth <- read.csv("../data/IGTdata_amphetamine.txt") # needs to be read.csv for the file format

# convert table to csv
write.csv(controls, "../data/IGTdata_healthy_control.csv", row.names = FALSE)
write.csv(heroin, "../data/IGTdata_heroin.csv", row.names = FALSE)
write.csv(meth, "../data/IGTdata_amphetamine.csv", row.names = FALSE)

# Load csvs
controls <-read.csv("../data/IGTdata_healthy_control.csv")
heroin <- read.csv("../data/IGTdata_heroin.csv")
meth <- read.csv("../data/IGTdata_amphetamine.csv")

# set row 1 in each df as the column names and delete row 1
colnames(controls) <- as.character(unlist(controls[1, ])) 
colnames(heroin) <- as.character(unlist(heroin[1, ]))
colnames(meth) <- as.character(unlist(meth[1, ]))

# delete row 1 with old column names
controls <- controls[-1, ]
heroin <- heroin[-1, ]
meth <- meth[-1, ]

```
```{r}
# merge data frames into one for easier processing
controls$group <- 'control'
heroin$group <- 'heroin'
meth$group <- 'methamphetamine'

# collect data for easy plotting
all_data <- all_data %>%
  mutate(gain = as.numeric(gain),
         loss = as.numeric(loss),
         payoff = gain + loss) %>%
  group_by(subjID, group) %>%
  arrange(trial) %>%
  mutate(cumulative_payoff = cumsum(payoff))

```


```{r}
# Table counting no. of completed trials per participant in each group
all_data %>%
  group_by(subjID, group) %>%
  summarise(max_trials = max(trial)) %>%
  group_by(max_trials) %>%
  summarise(count = n()) %>%
  arrange(desc(max_trials))

heroin %>%
  group_by(subjID) %>%
  summarise(max_trials = max(trial)) %>%
  group_by(max_trials) %>%
  summarise(count = n()) %>%
  arrange(desc(max_trials))

meth %>%
  group_by(subjID) %>%
  summarise(max_trials = max(trial)) %>%
  group_by(max_trials) %>%
  summarise(count = n()) %>%
  arrange(desc(max_trials))

# All groups only have participants with over 94 completed trials, with most completing 99 trials.

```


```{r}
# Count no. participants in each dataset
all_data %>%
  group_by(group) %>%
  summarise(count = n_distinct(subjID))
```

```{r}
# Check for missing data
sum(is.na(all_data))
```

```{r}
# Plot payoff per group as a distribution. Payoff is the total sum of gains and losses per participant
all_data %>%
  group_by(subjID, group) %>%
  summarise(payoff = sum(as.numeric(gain)) + sum(as.numeric(loss))) %>%
  ggplot(aes(x = payoff, fill = group)) +
  geom_histogram(position = "dodge", bins = 30, alpha = 0.7) +
  labs(title = "Distribution of Payoff by Group",
       x = "Payoff (Total Gains + Losses)",
       y = "Count of Participants") +
  theme_minimal()


# plot again as a line with density plotting total accumulative payoff over trials
all_data %>%
  ggplot(aes(x = trial, y = cumulative_payoff, group = subjID, color = group)) +
  stat_summary(aes(group = group, color = group), fun = mean, geom = "line", size = 1.5) +
  labs(title = "Cumulative Payoff Over Trials by Group",
       x = "Trial",
       y = "Cumulative Payoff") +
  theme_minimal()

# smoothed lines
all_data %>%
  ggplot(aes(x = trial, y = cumulative_payoff, color = group)) +
  geom_smooth(aes(group = group), method = "loess", se = TRUE, size = 1.5) +
  labs(title = "Cumulative Payoff Over Trials by Group (with SE)",
       x = "Trial",
       y = "Cumulative Payoff") +
  theme_minimal()


```
```{r}
# plot payoff per deck overall
all_data %>%
  group_by(deck) %>%
  ggplot(aes(x = deck, y = cumulative_payoff, fill = deck)) +
  geom_bar(stat = "identity", alpha = 0.7) +
  labs(title = "Total Payoff by Deck",
       x = "Deck",
       y = "Total Payoff (Gains + Losses)") +
  theme_minimal()
```

```{r}
# split decks into adv and disadv decks
#two of the decks (decks C and D) are advantageous (“good”) and two (decks A and B) are disadvantageous (“bad”) in terms of their long-term payoffs.
all_data <- all_data %>%
  mutate(deck_type = case_when(
    deck %in% c("3", "4") ~ "advantageous",
    deck %in% c("1", "2") ~ "disadvantageous",
    TRUE ~ NA_character_
  ))

# split the 100 trials were divided into five blocks of 20 trials
all_data <- all_data %>%  
  mutate(trial = as.numeric(trial)) %>%
  mutate(block = case_when(
    trial >= 1  & trial <= 19 ~ 1,
    trial >= 20 & trial <= 39 ~ 2,
    trial >= 40 & trial <= 59 ~ 3,
    trial >= 60 & trial <= 79 ~ 4,
    trial >= 80 & trial <= 100 ~ 5
  ))


```

```{r}
# Line Plot net score of “advantageous”—“disadvantageous” choices
all_data %>%
  group_by(subjID, group, deck_type) %>%
  summarise(total_choices = n()) %>%
  pivot_wider(names_from = deck_type, values_from = total_choices, values_fill = 0) %>%
  mutate(net_score = advantageous - disadvantageous) %>%
  ggplot(aes(x = group, y = net_score, fill = group)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Net Score of Advantageous vs Disadvantageous Choices by Group",
       x = "Group",
       y = "Net Score (Advantageous - Disadvantageous)") +
  theme_minimal()

# now with geom_line showing over blocks where 100 trials are split into 5 blocks
all_data %>%
  group_by(subjID, group, block, deck_type) %>%
  summarise(total_choices = n()) %>%
  pivot_wider(names_from = deck_type, values_from = total_choices, values_fill = 0) %>%
  mutate(net_score = advantageous - disadvantageous) %>%
  ggplot(aes(x = block, y = net_score, color = group)) +
  stat_summary(aes(group = group, color = group), fun = mean, geom = "line", size = 1.5) +
  labs(title = "Net Score of Advantageous vs Disadvantageous Choices Over Blocks by Group",
       x = "Block (20 Trials Each)",
       y = "Net Score (Advantageous - Disadvantageous)") +
  theme_minimal()

```


```{r}
# Check which rows have NA or non-numeric values in the plotting variable - ALL GOOD now
summary(all_data$block)
unique(all_data$trial[is.na(all_data$block)])

```

GOALS:
Calculate basic performance metrics for each group:
% choices from "good" decks (C, D) vs. "bad" decks (A, B)
Learning curves across trial blocks
Total money won/lost

```{r}
# Calculate % choices from "good" decks (C, D) vs. "bad" decks (A, B) - computes the mean across subjects in each group
all_data %>%
  group_by(subjID, group, deck_type) %>%
  summarise(total_choices = n()) %>%
  pivot_wider(names_from = deck_type, values_from = total_choices, values_fill = 0) %>%
  mutate(total = advantageous + disadvantageous,
         percent_advantageous = (advantageous / total) * 100,
         percent_disadvantageous = (disadvantageous / total) * 100) %>%
  group_by(group) %>%
  summarise(mean_percent_advantageous = mean(percent_advantageous),
            mean_percent_disadvantageous = mean(percent_disadvantageous))
```
```{r}
# percentage of choices per deck by group - BEST AS IT IS RELATIVE TO NO. TRIALS
deck_counts <- all_data %>%
  group_by(group, deck) %>%
  summarise(n_choices = n(), .groups = "drop") %>%
  group_by(group) %>%
  mutate(percent = n_choices / sum(n_choices) * 100)

ggplot(deck_counts, aes(x = deck, y = percent, fill = group)) +
  geom_col(position = "dodge") +
  labs(
    title = "Percent of Choices per Deck by Group",
    x = "Deck",
    y = "Percent of Choices"
  ) +
  theme_minimal() +
  scale_fill_brewer(palette = "Set1")
```


```{r}
# Plot how advantageous and disadvantageous decks are chosen per group
adv_disadv_counts <- all_data %>%
  group_by(group, deck_type) %>%
  summarise(n_choices = n(), .groups = "drop") %>% 
  group_by(group) %>%
  mutate(percent = n_choices / sum(n_choices) * 100)

ggplot(adv_disadv_counts, aes(x = deck_type, y = percent, fill = group))+
  geom_col(position = "dodge") +
  labs(
    title = "Number of Choices per Type of Deck by Group",
    x = "Deck Type",
    y = "Number of Choices"
  ) +
  theme_minimal() +
  scale_fill_brewer(palette = "Set1")

```

